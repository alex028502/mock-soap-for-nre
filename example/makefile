#this is from the same version of the lib as we install, but it doesn't have to be
original_program=https://raw.githubusercontent.com/robert-b-clarke/nre-darwin-py/c3862d820bb93e3595b22064eb61300332a19764/example.py

.PHONY: build clean clear-wsdl-cache

build: test-example.py virtualenv
clear-wsdl-cache:
	# it would be better to do this through suds so that we didn't delete caches
	# that belong to other applications, but this will work here
	rm -rf /tmp/suds
test-example.py: example.py
	echo "# this is a modified version of the production that allows you to inject a different" > test-example.py
	echo "# a different wsdl url using environment variable TEST_WSDL" >> test-example.py
	echo "import os" >> test-example.py
	echo "TEST_WSDL = os.environ['TEST_WSDL']" >> test-example.py
	echo "assert TEST_WSDL, 'must set TEST_WSDL env variable'"
	cat example.py | python build-resources/swsdl.py "'https://lite.realtime.nationalrail.co.uk/OpenLDBWS/wsdl.aspx'" TEST_WSDL >> test-example.py
	grep "modified for testing" test-example.py # fail if the file has not been modified
example.py: vendor/example.py
	echo "# this file is generated by makefile - do not edit" > example.py
	echo "" >> example.py
	echo '# this part is from the original program $(original_program)' >> example.py
	cat vendor/example.py >> example.py
	echo "" >> example.py
	echo "# and this part is added on:" >> example.py
	cat build-resources/stick-on-the-end-of-example.py >> example.py
vendor/example.py:
	wget $(original_program) -N -P vendor
virtualenv: requirements.txt
	rm -rf virtualenv
	virtualenv virtualenv
	virtualenv/bin/pip install -Ur requirements.txt
clean:
	rm -rf virtualenv
	rm -rf vendor/example.py
	rm -rf example.py
	rm -rf test-example.py
